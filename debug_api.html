<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß API Debug Tool</h1>
        
        <div class="section">
            <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞</h3>
            <input type="text" id="tokenInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ access_token">
            <button onclick="checkToken()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
            <div id="tokenResult"></div>
        </div>

        <div class="section">
            <h3>2. –¢–µ—Å—Ç API –∑–∞–ø—Ä–æ—Å–∞</h3>
            <input type="number" id="depositInput" placeholder="–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞" value="10.50">
            <button onclick="testAPI()">–¢–µ—Å—Ç API</button>
            <div id="apiResult"></div>
        </div>

        <div class="section">
            <h3>3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã</h3>
            <button onclick="testJSONP()">–¢–µ—Å—Ç JSONP</button>
            <button onclick="testFormData()">–¢–µ—Å—Ç Form Data</button>
            <button onclick="testCORS()">–¢–µ—Å—Ç CORS</button>
            <div id="altResult"></div>
        </div>

        <div class="section">
            <h3>4. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h3>
            <button onclick="viewSavedData()">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button onclick="clearSavedData()">–û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button onclick="exportSavedData()">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            <div id="savedData"></div>
        </div>

        <div class="section">
            <h3>5. –õ–æ–≥–∏</h3>
            <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            updateLogs();
        }
        
        function updateLogs() {
            document.getElementById('logs').innerHTML = logs.join('<br>');
        }
        
        function clearLogs() {
            logs = [];
            updateLogs();
        }
        
        function checkToken() {
            const token = document.getElementById('tokenInput').value;
            const resultDiv = document.getElementById('tokenResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">–¢–æ–∫–µ–Ω –Ω–µ –≤–≤–µ–¥–µ–Ω</div>';
                return;
            }
            
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞...');
            
            try {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JWT —Ç–æ–∫–µ–Ω–∞');
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const now = Math.floor(Date.now() / 1000);
                
                let status = 'success';
                let message = '<h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ:</h4>';
                message += `<pre>${JSON.stringify(payload, null, 2)}</pre>`;
                
                if (payload.exp && payload.exp < now) {
                    status = 'error';
                    message += '<div class="error">‚ö†Ô∏è –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫!</div>';
                } else if (payload.exp) {
                    const expDate = new Date(payload.exp * 1000);
                    message += `<div class="warning">‚è∞ –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç: ${expDate.toLocaleString()}</div>`;
                }
                
                resultDiv.innerHTML = `<div class="${status}">${message}</div>`;
                log(`–¢–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω: ${status}`);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞: ${error.message}`);
            }
        }
        
        async function testAPI() {
            const token = document.getElementById('tokenInput').value;
            const deposit = document.getElementById('depositInput').value;
            const resultDiv = document.getElementById('apiResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å –¥–µ–ø–æ–∑–∏—Ç–æ–º: ${deposit}`);
            
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            };
            
            const data = {
                deposit: deposit
            };
            
            try {
                const response = await fetch('https://api.valor-games.co/api/user/deposit/', {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(data)
                });
                
                log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ –£—Å–ø–µ—à–Ω–æ!</h4>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>`;
                    log('API –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω');
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå –û—à–∏–±–∫–∞ ${response.status}</h4>
                        <pre>${errorText}</pre>
                    </div>`;
                    log(`API –æ—à–∏–±–∫–∞: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
            }
        }
        
        function testJSONP() {
            log('JSONP –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è PUT –∑–∞–ø—Ä–æ—Å–æ–≤');
            document.getElementById('altResult').innerHTML = '<div class="warning">JSONP –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è PUT –∑–∞–ø—Ä–æ—Å–æ–≤</div>';
        }
        
        async function testFormData() {
            const token = document.getElementById('tokenInput').value;
            const deposit = document.getElementById('depositInput').value;
            const resultDiv = document.getElementById('altResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å FormData...');
            
            const formData = new FormData();
            formData.append('deposit', deposit);
            
            try {
                const response = await fetch('https://api.valor-games.co/api/user/deposit/', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                log(`FormData —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ FormData —Ä–∞–±–æ—Ç–∞–µ—Ç!</h4>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>`;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå FormData –æ—à–∏–±–∫–∞ ${response.status}</h4>
                        <pre>${errorText}</pre>
                    </div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå FormData –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`FormData –æ—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function testCORS() {
            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CORS...');
            
            try {
                // –ü—Ä–æ—Å—Ç–æ–π GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ CORS
                const response = await fetch('https://api.valor-games.co/api/user/deposit/', {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'PUT',
                        'Access-Control-Request-Headers': 'Authorization, Content-Type'
                    }
                });
                
                log(`CORS preflight —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                document.getElementById('altResult').innerHTML = `<div class="warning">
                    <h4>CORS Headers:</h4>
                    <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                </div>`;
                
            } catch (error) {
                log(`CORS –æ—à–∏–±–∫–∞: ${error.message}`);
                document.getElementById('altResult').innerHTML = `<div class="error">
                    <h4>‚ùå CORS –æ—à–∏–±–∫–∞</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        }
        
        function viewSavedData() {
            const savedData = JSON.parse(localStorage.getItem('failed_api_calls') || '[]');
            const resultDiv = document.getElementById('savedData');
            
            if (savedData.length === 0) {
                resultDiv.innerHTML = '<div class="warning">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            let html = `<h4>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (${savedData.length} –∑–∞–ø–∏—Å–µ–π):</h4>`;
            
            savedData.forEach((item, index) => {
                const date = new Date(item.timestamp).toLocaleString();
                html += `
                    <div style="border: 1px solid #ddd; margin: 5px 0; padding: 10px; border-radius: 3px;">
                        <strong>#${index + 1}</strong> - ${date}<br>
                        <strong>–î–µ–ø–æ–∑–∏—Ç:</strong> ${item.deposit}<br>
                        <strong>User ID:</strong> ${item.user_id}<br>
                        <strong>URL:</strong> ${item.url}
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
            log(`–ü–æ–∫–∞–∑–∞–Ω–æ ${savedData.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`);
        }
        
        function clearSavedData() {
            localStorage.removeItem('failed_api_calls');
            document.getElementById('savedData').innerHTML = '<div class="success">–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã</div>';
            log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
        }
        
        function exportSavedData() {
            const savedData = JSON.parse(localStorage.getItem('failed_api_calls') || '[]');
            
            if (savedData.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const csvContent = [
                'Timestamp,Deposit,User ID,URL',
                ...savedData.map(item => 
                    `${new Date(item.timestamp).toISOString()},${item.deposit},${item.user_id},"${item.url}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `failed_api_calls_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            log(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${savedData.length} –∑–∞–ø–∏—Å–µ–π –≤ CSV`);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('access_token');
            if (token) {
                document.getElementById('tokenInput').value = token;
                log('–¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ URL');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const savedData = JSON.parse(localStorage.getItem('failed_api_calls') || '[]');
            if (savedData.length > 0) {
                log(`–ù–∞–π–¥–µ–Ω–æ ${savedData.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`);
            }
        };
    </script>
</body>
</html>
