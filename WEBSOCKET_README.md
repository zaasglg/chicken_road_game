# Chicken Road WebSocket Server

WebSocket сервер для генерации ловушек в игре Chicken Road для всех уровней сложности.

## Установка и запуск

### 1. Установка зависимостей

```bash
npm install
```

### 2. Запуск сервера

```bash
# Обычный запуск
npm start

# Запуск в режиме разработки (с автоперезагрузкой)
npm run dev
```

### 3. Настройка порта

По умолчанию сервер запускается на порту 8080. Для изменения порта используйте переменную окружения:

```bash
PORT=3000 npm start
```

## API WebSocket

### Подключение

```javascript
const ws = new WebSocket('ws://localhost:8080');
```

### Сообщения

#### 1. Генерация ловушек

**Запрос:**
```json
{
    "type": "generate_traps",
    "level": "easy" // easy, medium, hard, hardcore
}
```

**Ответ:**
```json
{
    "type": "traps_generated",
    "data": {
        "level": "easy",
        "trapCount": 4,
        "traps": [5, 12, 18, 23],
        "sectors": 24,
        "coefficients": [1.02, 1.04, ...],
        "chance": [3, 8],
        "timestamp": "2024-01-01T12:00:00.000Z"
    }
}
```

#### 2. Получение списка уровней

**Запрос:**
```json
{
    "type": "get_levels"
}
```

**Ответ:**
```json
{
    "type": "levels_list",
    "levels": {
        "easy": { "trapCount": { "min": 3, "max": 6 }, ... },
        "medium": { "trapCount": { "min": 4, "max": 8 }, ... },
        "hard": { "trapCount": { "min": 5, "max": 10 }, ... },
        "hardcore": { "trapCount": { "min": 7, "max": 13 }, ... }
    }
}
```

#### 3. Ping/Pong

**Запрос:**
```json
{
    "type": "ping"
}
```

**Ответ:**
```json
{
    "type": "pong",
    "timestamp": "2024-01-01T12:00:00.000Z"
}
```

## Уровни сложности

### Easy
- Количество ловушек: 3-6
- Шанс ловушки в первом секторе: 5%
- Коэффициенты: 1.02 - 1.48

### Medium
- Количество ловушек: 4-8
- Шанс ловушки в первом секторе: 5%
- Коэффициенты: 1.05 - 2.10

### Hard
- Количество ловушек: 5-10
- Шанс ловушки в первом секторе: 5%
- Коэффициенты: 1.08 - 2.60

### Hardcore
- Количество ловушек: 7-13
- Шанс ловушки в первом секторе: 5%
- Коэффициенты: 1.10 - 2.40

## Интеграция с игрой

WebSocket клиент автоматически подключается к серверу при загрузке страницы игры. Если соединение недоступно, игра использует локальную генерацию ловушек.

### Использование в коде игры

```javascript
// Проверка подключения
if (window.trapWSClient && window.trapWSClient.isWebSocketConnected()) {
    // Запрос ловушек через WebSocket
    window.trapWSClient.generateTraps('easy');
} else {
    // Использование локальной генерации
    GAME.generateLocalTraps();
}

// Переключение режима
GAME.toggleWebSocketMode();
```

## Автоматическая генерация

Сервер автоматически генерирует ловушки для всех уровней каждые **30 секунд** и отправляет их всем подключенным клиентам.

## Логирование

Сервер выводит подробные логи:
- Подключения клиентов
- Автоматическую генерацию ловушек каждые 30 секунд
- Генерацию ловушек по запросу
- Ошибки и предупреждения

## Остановка сервера

Для корректной остановки сервера используйте `Ctrl+C`. Сервер выполнит graceful shutdown.

## Требования

- Node.js >= 14.0.0
- npm или yarn
